<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yusei+Magic&display=swap" rel="stylesheet">
    <style>
      /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘ãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®š â–¼â–¼â–¼ */
        font-family: 'Yusei Magic', sans-serif;
        margin: 0;
        background-color: #f4f7f9;
        color: #333;
      }

      /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
      .header {
        background: linear-gradient(135deg, #89f7fe, #66a6ff);
        color: white;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
      }
      .card.totals-card h2 {
        color: #333;
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 10px;
      }
      button {
        background: #66a6ff;
        display: block;
        width: 100%;
        padding: 14px;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-family: 'Yusei Magic', sans-serif; /* ãƒœã‚¿ãƒ³ã«ã‚‚ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      button:hover {
        opacity: 0.9;
      }

      .header h1 {
        margin: 0;
        font-size: 26px;
        letter-spacing: 1.5px;
      }

      /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
      #calendar-container {
        padding: 15px;
      }
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      .calendar-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }
      .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 8px;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 32px;
        font-size: 14px;
        border-radius: 50%;
        position: relative;
      }
      .day-in-month {
        cursor: default;
      }
      .day-other-month {
        color: #ccc;
        cursor: default;
      }
      .day-in-week {
        background-color: #eaf4ff;
      }
      .day-today {
        font-weight: bold;
        color: white;
        background-color: #66a6ff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .2);
      }
      /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

      /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
      .container {
        padding: 20px 15px;
        max-width: 600px;
        margin: 0 auto;
      }
      .card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
        padding: 20px;
        margin-bottom: 15px; /* ä½™ç™½ã‚’èª¿æ•´ */
      }
      .card.totals-card h2 {
        color: #333;
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 10px;
      }
      .totals-table {
        width: 100%;
        border-collapse: collapse;
      }
      .totals-table td {
        vertical-align: baseline;
        /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘è¡Œã”ã¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ â–¼â–¼â–¼ */
        padding: 2px 2px;
      }
      .totals-table tr:not(.monthly-row) td {
        padding-bottom: 0; /* é€±åˆè¨ˆã®è¡Œã®ä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã™ */
      }
      .totals-table tr.monthly-row td {
        padding-top: 0; /* æœˆåˆè¨ˆã®è¡Œã®ä¸Šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã™ */
        padding-bottom: 10px; /* æ¬¡ã®é …ç›®ã¨ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      }
      .totals-table tr:last-child td {
        padding-bottom: 0; /* æœ€å¾Œã®è¡Œã®ä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã™ */
      }
      /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
      .totals-table .item-label {
        font-size: 16px;
        width: 1%;
        white-space: nowrap;
      }
      .totals-table .amount {
        text-align: right;
      }
      .totals-table .weekly-usage {
        font-size: 26px;
        color: #2c3e50;
        width: 38%;
      }
      .totals-table .weekly-budget {
        font-size: 16px;
        color: #6c757d;
        width: 38%;
      }
      .totals-table .separator {
        font-size: 16px;
        color: #6c757d;
        text-align: center;
      }
      .totals-table .monthly-total {
        font-size: 14px;
        color: #6c757d;
        white-space: nowrap;
        /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘å³å¯„ã›ã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ â–¼â–¼â–¼ */
        text-align: right;
        padding-right: 4px;
        /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
      }
      .over-budget { color: #dc3545 !important; }
      /* â–¼â–¼â–¼ã€å¤‰æ›´ã€‘ãƒ¢ãƒ¼ãƒ€ãƒ«ã¨FABã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
      .fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #ffffff; /* ç™½ã«å¤‰æ›´ */
        color: #333; /* æ–‡å­—è‰²ã‚’æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
        font-size: 30px; /* çµµæ–‡å­—ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã«èª¿æ•´ */
        font-weight: bold; /* å¤ªå­—ã«è¨­å®š */
        border: 1px solid #dee2e6; /* è–„ã„å¢ƒç•Œç·šã‚’è¿½åŠ  */
        box-shadow: 0 4px 12px rgba(0,0,0,0.12); /* å½±ã‚’èª¿æ•´ */
        cursor: pointer;
        z-index: 1000;
        transition: transform 0.2s, background-color 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .fab:hover {
        transform: scale(1.05);
      }
      .fab:active {
        background-color: #f8f9fa; /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è–„ã„ã‚°ãƒ¬ãƒ¼ã« */
      }

      .history-fab {
        bottom: 25px;
        right: 95px; /* è¿½åŠ ãƒœã‚¿ãƒ³ã®å·¦ (25+60+10) */
      }

      /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: #f4f7f9;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }
      .modal-content h2 {
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #89f7fe, #66a6ff);
        color: white;
        font-size: 20px;
        border-radius: 12px 12px 0 0;
      }
      .modal-form-container {
        padding: 20px;
      }
      .close-modal-btn {
        position: absolute;
        top: 12px;
        right: 15px;
        background: none;
        border: none;
        font-size: 32px;
        color: rgba(255,255,255,0.8);
        cursor: pointer;
        padding: 0;
        line-height: 1;
        width: auto;
      }
      .hidden {
        display: none !important;
      }

      /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
      #snackbar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 14px 20px;
        border-radius: 8px;
        z-index: 3000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
      }
      #snackbar.show {
        opacity: 1;
        visibility: visible;
        bottom: 50px;
      }
      #snackbar.success { background-color: #28a745; }
      #snackbar.error { background-color: #dc3545; }
      /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
      
      /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
      .input-group { margin-bottom: 15px; }
      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #555;
      }
      .input-group select,
      .input-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
        font-family: 'Yusei Magic', sans-serif; /* ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚‚ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
      }
      .modal-form-container p {
        margin: 0 0 20px;
        font-size: 16px;
      }

      /* â–¼â–¼â–¼ã€è¿½åŠ ã€‘é›»å“UIã®ã‚¹ã‚¿ã‚¤ãƒ« â–¼â–¼â–¼ */
      #calculator {
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .calc-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .calc-btn {
        width: 32%;
        padding: 12px 0;
        font-size: 20px;
        font-weight: bold;
        background-color: #ffffff; /* ç™½ã«å¤‰æ›´ */
        color: #333;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®buttonã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .calc-btn:active {
        background-color: #f8f9fa; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */
      }
      /* â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² */
    </style>
  </head>
  <body>

    <div class="header">
      <h1>ğŸ’°é€±æ¬¡äºˆç®—ç®¡ç†ã‚¢ãƒ—ãƒªã¶ã‚Šã¶ã‚Š</h1>
    </div>

    <div class="container">
      <div class="card">
        <div id="calendar-container">
          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
      </div>

      <div class="card totals-card">
        <h2>åˆè¨ˆ</h2>
        <table class="totals-table">
          <tbody>
            <tr>
              <td class="item-label">ğŸ¥— é£Ÿè²»</td>
              <td class="amount weekly-usage" id="foodWeeklyUsage">...</td>
              <td class="separator">/</td>
              <td class="amount weekly-budget" id="foodWeeklyBudget">...</td>
            </tr>
            <tr class="monthly-row">
              <td colspan="4" class="monthly-total" id="foodMonthlyTotal">...</td>
            </tr>
            <tr>
              <td class="item-label">ğŸ§» æ—¥ç”¨å“</td>
              <td class="amount weekly-usage" id="dailyWeeklyUsage">...</td>
              <td class="separator">/</td>
              <td class="amount weekly-budget" id="dailyWeeklyBudget">...</td>
            </tr>
            <tr class="monthly-row">
              <td colspan="4" class="monthly-total" id="dailyMonthlyTotal">...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- â–¼â–¼â–¼ã€å¤‰æ›´ã€‘FABã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ â–¼â–¼â–¼ -->
    <button id="history-fab" class="fab history-fab">ğŸ“œ</button>
    <button id="add-expense-fab" class="fab">ï¼‹</button>

    <div id="expense-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="close-modal-btn" class="close-modal-btn">&times;</button>
        <h2>æ”¯å‡ºè¨˜éŒ²</h2>
        <div class="modal-form-container">
          <form id="expenseForm">
            <div class="input-group">
              <label for="category">è²»ç›®</label>
              <select id="category" name="category">
                <option value="é£Ÿè²»">ğŸ¥— é£Ÿè²»</option>
                <option value="æ—¥ç”¨å“">ğŸ§» æ—¥ç”¨å“</option>
              </select>
            </div>
            <div class="input-group">
              <label for="amount">é‡‘é¡</label>
              <input type="number" id="amount" name="amount" inputmode="numeric" required>
            </div>
            <!-- â–¼â–¼â–¼ã€è¿½åŠ ã€‘é›»å“UI â–¼â–¼â–¼ -->
            <div id="calculator">
              <div class="calc-row">
                <button type="button" class="calc-btn" data-value="7">7</button>
                <button type="button" class="calc-btn" data-value="8">8</button>
                <button type="button" class="calc-btn" data-value="9">9</button>
              </div>
              <div class="calc-row">
                <button type="button" class="calc-btn" data-value="4">4</button>
                <button type="button" class="calc-btn" data-value="5">5</button>
                <button type="button" class="calc-btn" data-value="6">6</button>
              </div>
              <div class="calc-row">
                <button type="button" class="calc-btn" data-value="1">1</button>
                <button type="button" class="calc-btn" data-value="2">2</button>
                <button type="button" class="calc-btn" data-value="3">3</button>
              </div>
              <div class="calc-row">
                <button type="button" class="calc-btn" data-value="0">0</button>
                <button type="button" class="calc-btn" data-value="00">00</button>
                <button type="button" class="calc-btn" data-action="clear">C</button>
              </div>
            </div>
            <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->
            <button type="submit" id="submitButton">è¨˜éŒ²ã™ã‚‹</button>
          </form>
        </div>
      </div>
    </div>


    <div id="history-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="close-history-modal-btn" class="close-modal-btn">&times;</button>
        <h2>ä»Šé€±ã®å±¥æ­´</h2>
        <div id="history-list-container" class="modal-form-container">
          <!-- ã“ã“ã«å±¥æ­´ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>
      </div>
    </div>
    <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->

    <div id="snackbar" class="hidden"></div>
    <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        showLoadingMessage();
        google.script.run.withSuccessHandler(updateDisplay).withFailureHandler(showError).getInitialData();
        
        const fab = document.getElementById('add-expense-fab');
        const modal = document.getElementById('expense-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');

        fab.addEventListener('click', () => modal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
          if (e.target === modal) { modal.classList.add('hidden'); }
        });

        // â–¼â–¼â–¼ã€è¿½åŠ ã€‘å±¥æ­´ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        const historyFab = document.getElementById('history-fab');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');

        historyFab.addEventListener('click', () => {
          const historyContainer = document.getElementById('history-list-container');
          historyContainer.innerHTML = '<p style="text-align: center;">å±¥æ­´ã‚’å–å¾—ä¸­...</p>';
          historyModal.classList.remove('hidden');
          google.script.run.withSuccessHandler(displayHistory).withFailureHandler(showError).getWeeklyExpenses();
        });

        closeHistoryModalBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
        historyModal.addEventListener('click', (e) => {
          if (e.target === historyModal) { historyModal.classList.add('hidden'); }
        });
        // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

        // â–¼â–¼â–¼ã€è¿½åŠ ã€‘é›»å“ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        const calculator = document.getElementById('calculator');
        const amountInput = document.getElementById('amount');

        calculator.addEventListener('click', (e) => {
          // ãƒœã‚¿ãƒ³è‡ªèº«ã€ã¾ãŸã¯ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã‚‚è€ƒæ…®
          const button = e.target.closest('.calc-btn');
          if (!button) return;

          const value = button.dataset.value;
          const action = button.dataset.action;

          if (value) {
            // ç¾åœ¨ã®å€¤ãŒ"0"ã®æ™‚ã«"0"ã‚„"00"ä»¥å¤–ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€ç½®ãæ›ãˆã‚‹
            if (amountInput.value === '0' && value !== '00') {
              amountInput.value = value;
            } 
            // ç©ºã®æ™‚ã«"00"ãŒæŠ¼ã•ã‚Œã¦ã‚‚å…¥åŠ›ã—ãªã„
            else if (amountInput.value === '' && value === '00') {
              return;
            } 
            // ãã‚Œä»¥å¤–ã¯è¿½è¨˜
            else {
              amountInput.value += value;
            }
          } else if (action === 'clear') {
            amountInput.value = '';
          }
        });
        // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

        // â–¼â–¼â–¼ã€è¿½åŠ ã€‘å±¥æ­´ãƒªã‚¹ãƒˆå†…ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
        const historyListContainer = document.getElementById('history-list-container');
        historyListContainer.addEventListener('click', (e) => {
          const deleteBtn = e.target.closest('.delete-btn');
          if (deleteBtn) {
            const row = deleteBtn.dataset.row;
            const listItem = deleteBtn.closest('li'); // å‰Šé™¤å¯¾è±¡ã®liè¦ç´ ã‚’äº‹å‰ã«å–å¾—

            // ç°¡æ˜“çš„ãªç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (confirm('ã“ã®è¨˜éŒ²ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
              showSnackbar('å‰Šé™¤ä¸­...', '');
              
              // æ–°ã—ã„æˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å½¢
              google.script.run.withSuccessHandler((newInitialData) => {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸæœ€æ–°ã®åˆè¨ˆå€¤ã§è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay(newInitialData);
                // ç”»é¢ã‹ã‚‰å±¥æ­´ã®é …ç›®ã‚’ç›´æ¥å‰Šé™¤
                listItem.remove();
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showSnackbar('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
              }).withFailureHandler(showError).deleteExpenseByRow(Number(row));
            }
          }
        });
        // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
      });

      document.getElementById('expenseForm').addEventListener('submit', function(e) { e.preventDefault(); const t = document.getElementById('submitButton'); t.disabled = true; t.textContent = 'å‡¦ç†ä¸­...'; const n = document.getElementById('category').value; const o = document.getElementById('amount').value; google.script.run.withSuccessHandler(onAddSuccess).withFailureHandler(showError).addExpense(n, o); });
      
      // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§æ—¥ä»˜ã‚’æ•´å½¢ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
      function formatDate(date, format) {
        const m = date.getMonth() + 1;
        const d = date.getDate();
        if (format === 'mm/dd') return `${m}/${d}`;
        return '';
      }

      function updateDisplay(data) {
        renderCalendar(data);

        // é£Ÿè²»ã®åˆè¨ˆã‚’æ›´æ–°
        const foodWeeklyUsageEl = document.getElementById('foodWeeklyUsage');
        foodWeeklyUsageEl.textContent = data.weeklyFoodUsage.toLocaleString() + 'å††';
        document.getElementById('foodWeeklyBudget').textContent = data.foodBudget.toLocaleString() + 'å††';
        document.getElementById('foodMonthlyTotal').textContent = '(æœˆ: ' + data.monthlyFoodUsage.toLocaleString() + 'å††)';
        if (data.weeklyFoodUsage > data.foodBudget) { foodWeeklyUsageEl.classList.add('over-budget'); } 
        else { foodWeeklyUsageEl.classList.remove('over-budget'); }

        // æ—¥ç”¨å“ã®åˆè¨ˆã‚’æ›´æ–°
        const dailyWeeklyUsageEl = document.getElementById('dailyWeeklyUsage');
        dailyWeeklyUsageEl.textContent = data.weeklyDailyGoodsUsage.toLocaleString() + 'å††';
        document.getElementById('dailyWeeklyBudget').textContent = data.dailyGoodsBudget.toLocaleString() + 'å††';
        document.getElementById('dailyMonthlyTotal').textContent = '(æœˆ: ' + data.monthlyDailyGoodsUsage.toLocaleString() + 'å††)';
        if (data.weeklyDailyGoodsUsage > data.dailyGoodsBudget) { dailyWeeklyUsageEl.classList.add('over-budget'); } 
        else { dailyWeeklyUsageEl.classList.remove('over-budget'); }

        resetForm();
      }

      function renderCalendar(data) {
        const container = document.getElementById('calendar-container');
        container.innerHTML = '';

        // â–¼â–¼â–¼ã€å¤‰æ›´ã€‘ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ â–¼â–¼â–¼
        const today = new Date(data.todayTime);
        const startOfWeek = new Date(data.startOfWeekTime);
        const endOfWeek = new Date(data.endOfWeekTime);
        const displayMonth = new Date(data.startOfMonthTime);
        // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

        const year = displayMonth.getFullYear();
        const month = displayMonth.getMonth();

        const monthName = (month + 1) + 'æœˆæœŸ';
        const weekNumberText = 'ç¬¬' + data.weekNumber + 'é€±';
        let html = `<div class="calendar-header"><h3>${year}å¹´ ${monthName} (${weekNumberText})</h3></div>`;
        html += '<div class="calendar-weekdays">';
        ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => { html += `<div>${day}</div>`; });
        html += '</div>';
        html += '<div class="calendar-grid">';

        const firstDayOfMonth = new Date(year, month, 1);
        const gridStartDate = new Date(firstDayOfMonth);
        gridStartDate.setDate(gridStartDate.getDate() - firstDayOfMonth.getDay());

        // all-dayã‚’è€ƒæ…®ã—ã¦ã€getTime()å‰ã«æ™‚åˆ»ã‚’0ã«è¨­å®š
        const todayMidnight = new Date(today); 
        todayMidnight.setHours(0,0,0,0);

        for (let i = 0; i < 42; i++) {
          const currentDate = new Date(gridStartDate);
          currentDate.setDate(currentDate.getDate() + i);
          let classes = 'calendar-day';
          if (currentDate.getMonth() === month) { classes += ' day-in-month'; } else { classes += ' day-other-month'; }
          if (currentDate >= startOfWeek && currentDate <= endOfWeek) { classes += ' day-in-week'; }
          if (currentDate.getTime() === todayMidnight.getTime()) { classes += ' day-today'; }
          html += `<div class="${classes}">${currentDate.getDate()}</div>`;
        }
        html += '</div>';
        container.innerHTML = html;
      }

      function onAddSuccess(data) { 
        updateDisplay(data); 
        showSnackbar('è¨˜éŒ²ã—ã¾ã—ãŸï¼', 'success');
        setTimeout(() => { document.getElementById('expense-modal').classList.add('hidden'); }, 1000);
      }


      function showError(error) { showSnackbar('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error'); resetForm(); }
      function resetForm() { document.getElementById('amount').value = ''; const t = document.getElementById('submitButton'); t.disabled = false; t.textContent = 'è¨˜éŒ²ã™ã‚‹'; }
      
      // â–¼â–¼â–¼ã€å¤‰æ›´ã€‘é€šçŸ¥ã‚’ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ã§è¡Œã†é–¢æ•° â–¼â–¼â–¼
      function showSnackbar(text, className) {
        const snackbar = document.getElementById('snackbar');
        snackbar.textContent = text;
        snackbar.className = className;
        snackbar.classList.add('show');
        setTimeout(() => { snackbar.classList.remove('show'); }, 3000);
      }

      function showLoadingMessage() { 
        document.getElementById('foodWeeklyUsage').textContent = '...'; 
        document.getElementById('dailyWeeklyUsage').textContent = '...'; 
      }

      function displayHistory(expenses) {
        const historyContainer = document.getElementById('history-list-container');
        if (expenses.length === 0) {
          historyContainer.innerHTML = '<p style="text-align: center;">ä»Šé€±ã®æ”¯å‡ºã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }

        let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
        expenses.forEach(expense => {
          const date = new Date(expense.timestamp);
          const dateString = `${date.getMonth() + 1}/${date.getDate()}(${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()]})`;
          const categoryIcon = expense.category === 'é£Ÿè²»' ? 'ğŸ¥—' : 'ğŸ§»';
          const amount = expense.amount.toLocaleString();
          
          html += `<li style="display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px; padding: 12px 4px; border-bottom: 1px solid #eee; font-size: 16px;">
                     <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${dateString} ${categoryIcon} ${expense.category}</span>
                     <span style="font-weight: bold; white-space: nowrap; text-align: right;">${amount}å††</span>
                     <button type="button" class="delete-btn" data-row="${expense.row}" style="background: none; border: none; font-size: 22px; color: #dc3545; cursor: pointer; padding: 0 5px;">âŒ</button>
                   </li>`;
        });
        html += '</ul>';
        historyContainer.innerHTML = html;
      }
    </script>
  </body>
</html>